<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline'; img-src 'self' data:; connect-src 'none'; child-src 'none'; object-src 'none'; base-uri 'none'; form-action 'none';">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Omega | Admin Password Tool</title>
  <style>
    :root {
      --bg: #f1f5f9;
      --surface: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --accent: #06b6d4;
      --border: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    :root[data-theme="dark"] {
      --bg: #0f172a;
      --surface: #1e293b;
      --text: #f8fafc;
      --muted: #94a3b8;
      --primary: #3b82f6;
      --primary-hover: #60a5fa;
      --border: #334155;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.3s;
    }

    .app-container {
      width: 100%;
      max-width: 1100px;
      height: 85vh;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: 1fr 350px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    /* --- Left: Main Generator --- */
    .main-panel {
      padding: 40px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
    .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }

    .display-box {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 30px;
      text-align: center;
      position: relative;
      margin-bottom: 20px;
      transition: border-color 0.2s;
    }
    .display-box:focus-within { border-color: var(--primary); }
    
    .password-text {
      font-family: 'Courier New', monospace;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text);
      word-break: break-all;
    }

    /* Phonetic Section */
    .phonetic-box {
      background: var(--surface);
      border: 1px dashed var(--border);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .phonetic-label { font-size: 0.75rem; text-transform: uppercase; color: var(--muted); font-weight: 700; margin-bottom: 8px; display: block; }
    .phonetic-text { 
      font-family: monospace; color: var(--muted); line-height: 1.6; font-size: 0.9rem; 
    }
    .phonetic-word { display: inline-block; padding: 2px 4px; background: var(--bg); border-radius: 4px; margin: 2px; }

    /* Controls */
    .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: auto; }
    
    .control-row { margin-bottom: 15px; }
    .label-flex { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
    
    input[type="range"] { width: 100%; accent-color: var(--primary); cursor: pointer; }

    .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .checkbox-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 10px; border: 1px solid var(--border);
      border-radius: 8px; cursor: pointer; font-size: 0.9rem;
      transition: background 0.2s;
    }
    .checkbox-btn:hover { background: var(--bg); }
    input[type="checkbox"] { accent-color: var(--primary); width: 16px; height: 16px; }

    .btn-large {
      background: var(--primary); color: white;
      border: none; border-radius: 8px;
      padding: 15px; font-size: 1.1rem; font-weight: 700;
      width: 100%; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      transition: background 0.2s;
    }
    .btn-large:hover { background: var(--primary-hover); }

    /* --- Right: History & Tools --- */
    .sidebar {
      background: var(--bg);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .sidebar-header { font-weight: 700; color: var(--muted); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

    .history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px; }
    
    .history-card {
      background: var(--surface);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .history-card:hover { border-color: var(--primary); transform: translateX(-2px); }
    .h-pass { font-family: monospace; font-weight: 600; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .h-meta { font-size: 0.75rem; color: var(--muted); margin-top: 5px; display: flex; justify-content: space-between; }

    .sidebar-actions { margin-top: 20px; display: flex; gap: 10px; }
    .btn-small {
      flex: 1; padding: 10px; border: 1px solid var(--border);
      background: var(--surface); border-radius: 6px; cursor: pointer;
      font-size: 0.85rem; font-weight: 600; color: var(--text);
      display: flex; justify-content: center; align-items: center; gap: 6px;
    }
    .btn-small:hover { background: var(--border); }

    .theme-switch {
      position: absolute; top: 20px; right: 20px;
    }

    /* Toast */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px);
      background: var(--text); color: var(--bg); padding: 10px 20px;
      border-radius: 50px; opacity: 0; transition: all 0.3s; pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    @media(max-width: 800px) {
      .app-container { grid-template-columns: 1fr; height: 100vh; border-radius: 0; }
      .sidebar { display: none; }
    }
  </style>
</head>
<body>

  <div class="app-container">
    
    <main class="main-panel">
      <header class="header">
        <div class="logo">OMEGA // GENERATOR</div>
        <button id="themeToggle" style="background:none; border:none; cursor:pointer; color:var(--text);">
           </button>
      </header>

      <div class="display-box">
        <div class="password-text" id="output">Loading...</div>
      </div>

      <div class="phonetic-box">
        <span class="phonetic-label">Phone Readout (NATO)</span>
        <div class="phonetic-text" id="phoneticOutput">
          </div>
      </div>

      <div class="controls-grid">
        <div>
          <div class="control-row">
            <div class="label-flex"><span>Length</span> <span id="lenVal">16</span></div>
            <input type="range" id="lenRange" min="8" max="64" value="16">
          </div>
          <button class="btn-large" id="btnGen">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
            Generate New
          </button>
        </div>

        <div class="checkbox-group">
          <label class="checkbox-btn">
            <input type="checkbox" id="chkUpper" checked> Uppercase
          </label>
          <label class="checkbox-btn">
            <input type="checkbox" id="chkNum" checked> Numbers
          </label>
          <label class="checkbox-btn">
            <input type="checkbox" id="chkSym" checked> Symbols
          </label>
          <label class="checkbox-btn">
            <input type="checkbox" checked disabled> No Ambiguous
          </label>
        </div>
      </div>
    </main>

    <aside class="sidebar">
      <div class="sidebar-header">
        <span>SESSION HISTORY</span>
        <span id="historyCount" style="font-size:0.8rem; background:var(--border); padding:2px 6px; border-radius:4px;">0</span>
      </div>
      
      <div class="history-list" id="historyList">
        </div>

      <div class="sidebar-actions">
        <button class="btn-small" id="btnExport">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export CSV
        </button>
        <button class="btn-small" onclick="clearHistory()" style="color:var(--danger); border-color:var(--border);">
          Clear
        </button>
      </div>
    </aside>

  </div>

  <div class="toast" id="toast">Copied! Clipboard clears in 60s.</div>

  <script>
    // --- Data & Config ---
    const CHARS = {
      lower: 'abcdefghijkmnpqrstuvwxyz',
      upper: 'ABCDEFGHJKLMNPQRSTUVWXYZ',
      num: '23456789',
      sym: '!@#$%^&*()_+-='
    };

    const PHONETIC = {
      'a': 'alpha', 'b': 'bravo', 'c': 'charlie', 'd': 'delta', 'e': 'echo', 'f': 'foxtrot',
      'g': 'golf', 'h': 'hotel', 'i': 'india', 'j': 'juliett', 'k': 'kilo', 'l': 'lima',
      'm': 'mike', 'n': 'november', 'o': 'oscar', 'p': 'papa', 'q': 'quebec', 'r': 'romeo',
      's': 'sierra', 't': 'tango', 'u': 'uniform', 'v': 'victor', 'w': 'whiskey', 'x': 'x-ray',
      'y': 'yankee', 'z': 'zulu', '0': 'zero', '1': 'one', '2': 'two', '3': 'three', '4': 'four',
      '5': 'five', '6': 'six', '7': 'seven', '8': 'eight', '9': 'nine',
      '!': 'bang', '@': 'at', '#': 'hash', '$': 'dollar', '%': 'percent', '^': 'caret',
      '&': 'ampersand', '*': 'star', '(': 'open-paren', ')': 'close-paren', '-': 'dash',
      '_': 'underscore', '+': 'plus', '=': 'equals'
    };

    let historyData = [];
    let clipboardClearTimeoutId;

    // --- DOM Elements ---
    const els = {
      out: document.getElementById('output'),
      phonetic: document.getElementById('phoneticOutput'),
      lenRange: document.getElementById('lenRange'),
      lenVal: document.getElementById('lenVal'),
      history: document.getElementById('historyList'),
      historyCount: document.getElementById('historyCount'),
      btnGen: document.getElementById('btnGen'),
      btnExport: document.getElementById('btnExport'),
      toast: document.getElementById('toast'),
      themeBtn: document.getElementById('themeToggle')
    };

    // --- Core Logic ---
    function generate() {
      const len = parseInt(els.lenRange.value);
      let pool = CHARS.lower;
      
      if (document.getElementById('chkUpper').checked) pool += CHARS.upper;
      if (document.getElementById('chkNum').checked) pool += CHARS.num;
      if (document.getElementById('chkSym').checked) pool += CHARS.sym;

      const arr = new Uint32Array(len);
      window.crypto.getRandomValues(arr);
      
      let pass = '';
      for (let i = 0; i < len; i++) {
        pass += pool[arr[i] % pool.length];
      }

      updateUI(pass);
      addToHistory(pass);
    }

    function updateUI(pass) {
      els.out.textContent = pass;
      
      // Update Phonetic Speller
      els.phonetic.innerHTML = pass.split('').map(char => {
        const lower = char.toLowerCase();
        let word = PHONETIC[lower] || char;
        if (/[A-Z]/.test(char)) word = word.toUpperCase(); 
        return `<span class="phonetic-word">${word}</span>`;
      }).join(' ');
    }

    function addToHistory(pass) {
      const timestamp = new Date().toLocaleString();
      historyData.unshift({ pass, timestamp });
      if (historyData.length > 50) historyData.pop(); 
      renderHistory();
    }

    function renderHistory() {
      els.historyCount.textContent = historyData.length;
      els.history.innerHTML = '';
      
      historyData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-card';
        div.innerHTML = `
          <div class="h-pass">${item.pass}</div>
          <div class="h-meta">
            <span>${item.timestamp.split(',')[1]}</span>
            <span>Copy</span>
          </div>
        `;
        div.onclick = () => copyToClipboard(item.pass);
        els.history.appendChild(div);
      });
    }

    // --- Features ---

    // 1. Smart Clipboard
    function copyToClipboard(text) {
      if(!text) text = els.out.textContent;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied! Clipboard clears in 60s');
        if (clipboardClearTimeoutId) clearTimeout(clipboardClearTimeoutId);
        clipboardClearTimeoutId = setTimeout(() => {
          navigator.clipboard.writeText(' ').catch(() => {
            showToast('Clipboard permission denied');
          });
        }, 60000);
      }).catch(() => {
        showToast('Clipboard permission denied');
      });
    }

    // 2. FIXED CSV Export (Uses Blob instead of Data URI)
    function exportHistory() {
      if (historyData.length === 0) return;
      
      // Header
      let csvContent = "Timestamp,Password\n";
      
      // Rows
      historyData.forEach(row => {
        // Escape quotes inside passwords by doubling them: " -> ""
        let safePass = row.pass.replace(/"/g, '""');
        // Wrap password in quotes to handle commas/newlines/hashes
        csvContent += `${row.timestamp},"${safePass}"\n`;
      });

      // Create a Blob (Binary Large Object)
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      
      // Create a link to the Blob
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "omega_password_history.csv");
      document.body.appendChild(link);
      
      // Trigger download
      link.click();
      
      // Cleanup
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function clearHistory() {
      historyData = [];
      renderHistory();
    }

    function showToast(msg) {
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 2500);
    }

    // --- Init ---
    els.btnGen.addEventListener('click', generate);
    els.out.addEventListener('click', () => copyToClipboard());
    els.lenRange.addEventListener('input', (e) => { els.lenVal.textContent = e.target.value; generate(); });
    els.btnExport.addEventListener('click', exportHistory);
    
    document.querySelectorAll('input[type="checkbox"]').forEach(box => {
      box.addEventListener('change', generate);
    });

    // Theme Logic
    let isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    function updateTheme() {
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      els.themeBtn.innerHTML = isDark 
        ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
        : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
    }
    els.themeBtn.addEventListener('click', () => { isDark = !isDark; updateTheme(); });
    updateTheme();
    generate(); 
  </script>
</body>
</html>
